# 实现分布式事务

## rocketMQ实现分布式事务

定时任务扫描到奖励表，发送到mq，用户服务订阅这个服务增加积分  

订单-受益人-奖励-状态

### try阶段

1. 阶段奖励表状态更新为正在发放,
2. 向mq发送消息header={order_id tx_id}  body={奖励记录}
3. 收到消息 update 状态为已发送，然后本地事务表插入一条记录(tx_id desc  方便回查)，给mq发消息说commit/rollback
4. 如果未收到 刚刚的commit/rollback，就主动根据tx_id查本地事务表，如果有这条表示事务成功，没有就表示事务失败

### confirm/cancel阶段

​	用户积分服务订阅这个MQ，收到消息拿出来，找到对应的用户增加积分，和收支记录

为了防止重复消费，需要根据order_id来判断幂等性，如果收支记录有这笔订单的积分那么直接返回



## 	ActiveMqS实现分布式事务